# ğŸš€ UNIVERSAL BUILD + VERCEL DEPLOY PIPELINE
# Works on GitLab, deploys to Vercel automatically.
# Builds Node, Python, PHP, Java, and static sites.
# Keeps all build outputs.

image: ubuntu:latest

stages:
  - setup
  - build
  - test
  - deploy

variables:
  DEBIAN_FRONTEND: noninteractive
  BUILD_DIR: build_output
  VERCEL_ORG_ID: $VERCEL_ORG_ID
  VERCEL_PROJECT_ID: $VERCEL_PROJECT_ID
  VERCEL_TOKEN: $VERCEL_TOKEN

before_script:
  - echo "ğŸ§© Installing dependencies..."
  - apt update -y
  - apt install -y curl git python3 python3-pip php openjdk-17-jdk nodejs npm
  - node -v && npm -v && python3 --version && php -v && javac -version

# ğŸ§± Stage 1: Environment Setup
setup_env:
  stage: setup
  script:
    - echo "ğŸš€ Setting up environment..."
    - if [ -f package.json ]; then echo "ğŸ“¦ Installing Node dependencies"; npm install || true; fi
    - if [ -f requirements.txt ]; then echo "ğŸ Installing Python dependencies"; pip3 install -r requirements.txt || true; fi
    - if [ -f composer.json ]; then
        echo "ğŸ˜ Installing Composer dependencies";
        curl -sS https://getcomposer.org/installer | php;
        php composer.phar install || true;
      fi
    - echo "âœ… Setup complete!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - ~/.cache/pip
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 week

# ğŸ—ï¸ Stage 2: Build all projects
build_all:
  stage: build
  script:
    - echo "ğŸ—ï¸ Building all detected projects..."
    - mkdir -p $BUILD_DIR

    # Node
    - if npm run | grep -q "build"; then echo "ğŸ› ï¸ Running npm build"; npm run build || true; fi

    # Python
    - if [ -f setup.py ]; then echo "ğŸ Building Python package"; python3 setup.py build || true; fi
    - if [ -d "static" ]; then echo "ğŸ“‚ Copying static assets"; cp -r static/* $BUILD_DIR/ || true; fi

    # Java
    - if ls *.java 1> /dev/null 2>&1; then
        echo "â˜• Compiling Java code";
        mkdir -p java_build;
        javac -d java_build $(find . -name "*.java") || true;
        jar cf java_build/app.jar -C java_build . || true;
        cp -r java_build/* $BUILD_DIR/ || true;
      fi

    # PHP
    - if ls *.php 1> /dev/null 2>&1; then echo "ğŸ˜ Copying PHP files"; cp -r *.php $BUILD_DIR/ || true; fi

    # Static files
    - if [ -d "public" ]; then echo "ğŸŒ Found public folder, copying"; cp -r public/* $BUILD_DIR/ || true; fi
    - if [ -f "index.html" ]; then cp index.html $BUILD_DIR/; fi

    - echo "âœ… Build complete!"
  artifacts:
    paths:
      - $BUILD_DIR/
    expire_in: 1 week
  dependencies:
    - setup_env

# ğŸ§ª Stage 3: Tests
test_all:
  stage: test
  script:
    - echo "ğŸ” Running tests..."
    - if command -v npx > /dev/null; then npx eslint . || echo "âš ï¸ Skipping ESLint"; fi
    - if ls *.py 1> /dev/null 2>&1; then python3 -m py_compile *.py || true; fi
    - if ls *.php 1> /dev/null 2>&1; then php -l *.php || true; fi
    - if ls *.java 1> /dev/null 2>&1; then javac $(find . -name "*.java") || true; fi
    - test -f index.html && echo "âœ… index.html found" || echo "âš ï¸ No index.html"
    - echo "âœ… Test stage complete!"

# ğŸŒ Stage 4: Deploy to Vercel
deploy_vercel:
  stage: deploy
  script:
    - echo "ğŸš€ Deploying to Vercel..."
    - npm install -g vercel
    - vercel --version
    - vercel deploy --prebuilt --yes --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID --project=$VERCEL_PROJECT_ID --prod
    - echo "ğŸŒ Deployment to Vercel complete!"
  only:
    - main
  dependencies:
    - build_all
