stages:
  - test
  - security
  - build
  - deploy

# --- Include all GitLab security templates ---
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml

# --- Global Variables ---
variables:
  SAST_ENABLED: 'true'
  SECRET_DETECTION_ENABLED: 'true'
  DEPENDENCY_SCANNING_ENABLED: 'true'
  CONTAINER_SCANNING_ENABLED: 'true'
  NODE_ENV: 'production'
  # You can tweak this if your build folder is named something else
  BUILD_DIR: 'build'

# --- SAST (Static Application Security Testing) ---
sast:
  stage: test

# --- Secret Detection ---
secret_detection:
  stage: security

# --- Dependency Scanning ---
dependency_scanning:
  stage: security

# --- Container Scanning (optional, safe even if no Dockerfile) ---
container_scanning:
  stage: security
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# --- Build React Site ---
build_site:
  image: node:20
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - $BUILD_DIR
    expire_in: 1 hour

# --- Deploy to GitLab Pages ---
pages:
  image: node:20
  stage: deploy
  script:
    - mkdir public
    - cp -r $BUILD_DIR/* public
  artifacts:
    paths:
      - public
  only:
    - main
