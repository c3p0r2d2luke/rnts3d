# ğŸŒ THE ULTIMATE CI PIPELINE
# Supports Node, Python, PHP, Java, and static sites.
# Automatically builds, tests, and deploys everything it detects.
# (GitLab Pages deployment removed)

image: ubuntu:latest

stages:
  - setup
  - build
  - test

variables:
  DEBIAN_FRONTEND: noninteractive
  PUBLIC_DIR: .public

before_script:
  - echo "ğŸ§© Installing dependencies..."
  - apt update -y
  - apt install -y curl git python3 python3-pip php openjdk-17-jdk nodejs npm
  - node -v && npm -v && python3 --version && php -v && javac -version

# ğŸ§± Stage 1: Environment Setup
setup_env:
  stage: setup
  script:
    - echo "ğŸš€ Setting up environment..."
    - if [ -f package.json ]; then echo "ğŸ“¦ Installing Node dependencies"; npm install || true; fi
    - if [ -f requirements.txt ]; then echo "ğŸ Installing Python dependencies"; pip3 install -r requirements.txt || true; fi
    - if [ -f composer.json ]; then
        echo "ğŸ˜ Installing Composer dependencies";
        curl -sS https://getcomposer.org/installer | php;
        php composer.phar install || true;
      fi
    - echo "âœ… Setup complete!"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - ~/.cache/pip
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 week

# ğŸ—ï¸ Stage 2: Build everything automatically
build_all:
  stage: build
  script:
    - echo "ğŸ—ï¸ Building all detected projects..."
    - mkdir -p build_output

    # Node
    - if npm run | grep -q "build"; then echo "ğŸ› ï¸ Running npm build"; npm run build || true; fi

    # Python
    - if [ -f setup.py ]; then echo "ğŸ Building Python package"; python3 setup.py build || true; fi
    - if [ -d "static" ]; then echo "ğŸ“‚ Copying static assets"; cp -r static/* build_output/ || true; fi

    # Java
    - if ls *.java 1> /dev/null 2>&1; then
        echo "â˜• Compiling Java code";
        mkdir -p java_build;
        javac -d java_build $(find . -name "*.java") || true;
        jar cf java_build/app.jar -C java_build . || true;
      fi

    # PHP
    - if ls *.php 1> /dev/null 2>&1; then echo "ğŸ˜ PHP files detected, preparing build"; cp -r *.php build_output/ || true; fi

    # Static files
    - if [ -d "public" ]; then echo "ğŸŒ Found public folder, copying"; cp -r public/* build_output/ || true; fi
    - if [ -f "index.html" ]; then cp index.html build_output/; fi

    - echo "âœ… Build complete!"
  artifacts:
    paths:
      - build_output/
    expire_in: 1 week
  dependencies:
    - setup_env

# ğŸ§ª Stage 3: Tests for every language
test_all:
  stage: test
  script:
    - echo "ğŸ” Running all tests..."

    # JS Lint
    - if command -v npx > /dev/null; then npx eslint . || echo "âš ï¸ Skipping ESLint"; fi

    # Python syntax
    - if ls *.py 1> /dev/null 2>&1; then python3 -m py_compile *.py || true; fi

    # PHP syntax
    - if ls *.php 1> /dev/null 2>&1; then php -l *.php || true; fi

    # Java compile test
    - if ls *.java 1> /dev/null 2>&1; then javac $(find . -name "*.java") || true; fi

    # HTML presence
    - test -f index.html && echo "âœ… index.html found" || echo "âš ï¸ No index.html"

    - echo "âœ… Test stage complete!"
